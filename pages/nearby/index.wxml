<t-toast id="t-toast" />

<view class="nearby">
  <nav title-text="本地信息流" />

  <view class="lf-tabs">
    <view class="lf-tabs__items">
      <view class="lf-tabs__item {{viewMode === 'map' ? 'is-active' : ''}}" data-mode="map" bindtap="onSwitchMode">
        地图
      </view>
      <view
        class="lf-tabs__item {{viewMode === 'publish' ? 'is-active' : ''}}"
        data-mode="publish"
        bindtap="onSwitchMode"
      >
        发布
      </view>
      <view class="lf-tabs__indicator" style="left: {{modeIndicatorLeft}}; width: {{modeIndicatorWidth}};">
        <view class="lf-tabs__bar" />
      </view>
    </view>
  </view>

  <view class="lf-body">
    <view wx:if="{{viewMode === 'map'}}" class="map-wrap">
      <map
        id="lfMap"
        class="nearby__map"
        latitude="{{center.lat}}"
        longitude="{{center.lng}}"
        scale="{{mapScale}}"
        markers="{{markers}}"
        show-location
        enable-scroll
        enable-zoom
        bindmarkertap="onMarkerTap"
        bindregionchange="onRegionChange"
      />
    </view>

    <scroll-view wx:else class="publish-view" scroll-y enhanced>
      <view class="publish-page">
        <view wx:if="{{needHomeBase}}" class="alert-card">
          <view class="alert-card__title">首次使用需要设置固定地址点位</view>
          <view class="alert-card__desc">设置后，你的头像点位才会出现在地图上，也才能发布内容。</view>
          <view class="alert-card__actions">
            <t-button size="small" theme="primary" bind:tap="onSetHomeBaseToCurrent" disabled="{{!isLoggedIn}}">
              用当前位置设置
            </t-button>
            <t-button size="small" variant="outline" theme="default" bind:tap="onChooseHomeBase" disabled="{{!isLoggedIn}}">
              地图选点
            </t-button>
          </view>
          <view wx:if="{{!isLoggedIn}}" class="hint">请先登录后设置地址</view>
        </view>

        <view class="hud-card">
          <view class="hud-card__row">
            <view class="hud-card__title">本地信息流</view>
            <view class="hud-card__sub">{{locationStatus}}</view>
          </view>
          <view class="hud-card__actions">
            <t-button size="small" variant="outline" theme="default" bind:tap="onRefresh">刷新</t-button>
            <t-button size="small" variant="outline" theme="default" bind:tap="onOpenRequests">
              请求 {{pendingRequests.length}}
            </t-button>
            <t-button size="small" theme="primary" bind:tap="onOpenPublish">发布</t-button>
          </view>
        </view>

        <view class="publish-card">
          <view class="publish-card__title">我的固定地址点位</view>
          <view class="publish-card__sub" wx:if="{{homeBase}}">
            已设置：{{homeBase.name || '我的位置'}}（{{homeBase.latText}}, {{homeBase.lngText}}）
          </view>
          <view class="publish-card__sub" wx:else>未设置。首次使用本地信息流需设置一个固定地址点位。</view>

          <view class="publish-card__actions">
            <t-button size="small" variant="outline" theme="default" bind:tap="onSetHomeBaseToCurrent" disabled="{{!isLoggedIn}}">
              用当前位置
            </t-button>
            <t-button size="small" variant="outline" theme="default" bind:tap="onChooseHomeBase" disabled="{{!isLoggedIn}}">
              地图选点
            </t-button>
          </view>
          <view wx:if="{{!isLoggedIn}}" class="hint">请先登录后设置地址</view>
        </view>

        <view class="publish-card">
          <view class="publish-card__row">
            <view class="publish-card__title">我的发布</view>
            <t-button size="small" theme="primary" bind:tap="onOpenPublish" disabled="{{!isLoggedIn}}">发布</t-button>
          </view>

          <view wx:if="{{!isLoggedIn}}" class="empty">请先登录后查看与发布内容</view>
          <view wx:elif="{{!myPosts.length}}" class="empty">暂无发布</view>

          <view wx:else class="my-posts">
            <view wx:for="{{myPosts}}" wx:key="id" class="my-post">
              <view class="my-post__head">
                <view class="my-post__title">{{item.text || '（图片）'}}</view>
                <view wx:if="{{item.pinned}}" class="my-post__pin">置顶</view>
              </view>
              <view class="my-post__meta">
                半径 {{item.radiusKm}}km · 有效至 {{item.expiresAtText}}
              </view>
            </view>
          </view>
        </view>
      </view>
    </scroll-view>
  </view>

  <t-popup visible="{{detailVisible}}" placement="bottom" overlay bind:visible-change="onDetailVisibleChange">
    <view class="sheet">
      <view class="sheet__header">
        <view class="sheet__title">信息源预览</view>
        <t-icon name="close" size="48rpx" bind:tap="onCloseDetail" />
      </view>

      <view wx:if="{{selectedUser}}" class="post">
        <view class="post__head">
          <t-avatar image="{{selectedUser.avatarUrl || '/static/chat/avatar.png'}}" size="small" />
          <view class="post__meta">
            <view class="post__name">{{selectedUser.displayName || '本地的人'}}</view>
            <view class="post__time">点击「查看信息源」浏览其发布</view>
          </view>
        </view>

        <view wx:if="{{selectedUserPosts && selectedUserPosts.length}}" class="preview">
          <view class="preview__title">最近发布</view>
          <view wx:for="{{selectedUserPosts}}" wx:key="id" class="preview__item">
            <view class="preview__text">{{item.text || '（图片）'}}</view>
            <view class="preview__meta">
              半径 {{item.radiusKm}}km · 有效至 {{item.expiresAtText}}
            </view>
          </view>
        </view>

        <view class="sheet__actions">
          <t-button theme="default" variant="outline" block bind:tap="onViewProfile">查看信息源</t-button>
          <t-button
            theme="primary"
            block
            style="margin-top: 16rpx;"
            disabled="{{connectButtonDisabled}}"
            bind:tap="onTapConnect"
          >
            {{connectButtonText}}
          </t-button>
          <view wx:if="{{connectButtonHint}}" class="hint">{{connectButtonHint}}</view>
        </view>
      </view>
    </view>
  </t-popup>

  <t-popup visible="{{requestsVisible}}" placement="bottom" overlay bind:visible-change="onRequestsVisibleChange">
    <view class="sheet">
      <view class="sheet__header">
        <view class="sheet__title">连接请求</view>
        <t-icon name="close" size="48rpx" bind:tap="onCloseRequests" />
      </view>

      <view wx:if="{{!isLoggedIn}}" class="empty">请先登录后查看请求</view>
      <view wx:elif="{{loadingRequests}}" class="empty">加载中…</view>
      <view wx:elif="{{!pendingRequests.length}}" class="empty">暂无请求</view>

      <t-cell-group wx:else theme="card">
        <t-cell
          wx:for="{{pendingRequests}}"
          wx:key="id"
          title="{{item.user.displayName || '对方'}}"
          description="{{item.request.verificationMessage || '申请建立会话'}}"
          image="{{item.user.avatarUrl || '/static/chat/avatar.png'}}"
        >
          <view slot="right-icon" class="req-actions">
            <t-button size="small" theme="primary" variant="base" bind:tap="onAcceptRequest" data-id="{{item.id}}"
              >同意</t-button
            >
            <t-button
              size="small"
              theme="default"
              variant="outline"
              style="margin-left: 12rpx;"
              bind:tap="onRejectRequest"
              data-id="{{item.id}}"
            >
              拒绝
            </t-button>
          </view>
        </t-cell>
      </t-cell-group>
    </view>
  </t-popup>

  <t-popup visible="{{publishVisible}}" placement="bottom" overlay bind:visible-change="onPublishVisibleChange">
    <view class="sheet">
      <view class="sheet__header">
        <view class="sheet__title">发布动态</view>
        <t-icon name="close" size="48rpx" bind:tap="onClosePublish" />
      </view>

      <view class="publish">
        <textarea
          class="publish__textarea"
          placeholder="写点什么…"
          value="{{draft.text}}"
          maxlength="500"
          bindinput="onDraftTextInput"
          disabled="{{!isLoggedIn}}"
        />

        <view class="publish__row">
          <view class="publish__label">有效期（天）</view>
          <input
            class="publish__input"
            type="number"
            value="{{draft.ttlDays}}"
            placeholder="例如 30"
            bindinput="onTtlDaysInput"
            disabled="{{!isLoggedIn}}"
          />
        </view>

        <view class="publish__row">
          <view class="publish__label">可见半径（km）</view>
          <input
            class="publish__input"
            type="number"
            value="{{draft.radiusKm}}"
            placeholder="例如 1"
            bindinput="onRadiusKmInput"
            disabled="{{!isLoggedIn}}"
          />
        </view>

        <view class="publish__row">
          <view class="publish__label">置顶</view>
          <switch checked="{{draft.pinned}}" bindchange="onPinnedChange" disabled="{{!isLoggedIn}}" />
        </view>

        <view wx:if="{{draft.images && draft.images.length}}" class="images">
          <view wx:for="{{draft.images}}" wx:key="index" class="images__item">
            <image class="images__img" mode="aspectFill" src="{{item}}" bind:tap="onPreviewDraftImage" data-index="{{index}}" />
            <view class="images__remove" bind:tap="onRemoveDraftImage" data-index="{{index}}">
              <t-icon name="close-circle-filled" size="36rpx" color="#fa5151" />
            </view>
          </view>
        </view>

        <view class="publish__actions">
          <t-button theme="default" variant="outline" bind:tap="onPickImages" disabled="{{!isLoggedIn}}">选图</t-button>
          <t-button theme="primary" bind:tap="onPublish" disabled="{{!isLoggedIn}}">发布</t-button>
        </view>
        <view wx:if="{{!isLoggedIn}}" class="hint">请先登录后再发布</view>
      </view>
    </view>
  </t-popup>

  <t-popup visible="{{verificationVisible}}" placement="bottom" overlay bind:visible-change="onVerificationVisibleChange">
    <view class="sheet">
      <view class="sheet__header">
        <view class="sheet__title">验证消息</view>
        <t-icon name="close" size="48rpx" bind:tap="onCloseVerification" />
      </view>
      <view class="publish">
        <textarea
          class="publish__textarea"
          placeholder="写一句话，帮助对方判断要不要同意…"
          value="{{verificationText}}"
          maxlength="120"
          bindinput="onVerificationInput"
        />
        <view class="publish__actions">
          <t-button theme="default" variant="outline" bind:tap="onCloseVerification">取消</t-button>
          <t-button theme="primary" bind:tap="onSendConnectRequest">发送请求</t-button>
        </view>
      </view>
    </view>
  </t-popup>
</view>

<scan-fab />
