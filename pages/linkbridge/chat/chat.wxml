<view class="lb-page">
  <t-navbar class="lb-chat__navbar" title="{{navbarTitle}}" leftArrow>
    <t-button
      slot="capsule"
      theme="danger"
      variant="base"
      shape="round"
      size="small"
      bind:tap="onTapEndSession"
    >
      结束会话
    </t-button>
  </t-navbar>

  <view class="lb-chat">
    <scroll-view
      class="lb-chat__messages"
      scroll-y
      scroll-with-animation
      scroll-into-view="{{scrollIntoView}}"
    >
      <view wx:if="{{messages.length === 0}}" class="lb-chat__empty">
        <text class="lb-chat__empty-text">开始发送消息吧</text>
      </view>

      <view
        wx:for="{{messages}}"
        wx:key="id"
        id="msg-{{item.id}}"
        class="lb-chat__message-row lb-chat__message-row--{{item.sender}}"
      >
        <view class="lb-chat__bubble lb-chat__bubble--{{item.sender}}">
          <block wx:if="{{item.type === 'text'}}">
            <text class="lb-chat__bubble-text">{{item.text}}</text>
          </block>
          <block wx:elif="{{item.type === 'image'}}">
            <view class="lb-chat__attachment">
              <t-icon name="image" class="lb-chat__attachment-icon" />
              <text class="lb-chat__attachment-text">图片</text>
            </view>
          </block>
          <block wx:elif="{{item.type === 'file'}}">
            <view class="lb-chat__attachment">
              <t-icon name="file" class="lb-chat__attachment-icon" />
              <text class="lb-chat__attachment-text">{{item.meta.name || 'demo.pdf'}}</text>
            </view>
          </block>
          <block wx:else>
            <text class="lb-chat__bubble-text">[未知消息]</text>
          </block>
        </view>
      </view>
    </scroll-view>

    <view class="lb-chat__composer">
      <t-button
        class="lb-chat__composer-btn"
        variant="text"
        icon="add"
        aria-label="更多"
        bind:tap="onTapPlus"
      />
      <t-input
        class="lb-chat__composer-input"
        borderless
        clearable
        value="{{inputValue}}"
        placeholder="发送消息..."
        confirmType="send"
        bindchange="onInputChange"
        bindenter="onTapSend"
      />
      <t-button
        class="lb-chat__composer-send"
        theme="primary"
        shape="round"
        size="small"
        icon="send"
        content="发送"
        disabled="{{!canSend}}"
        bind:tap="onTapSend"
      />
    </view>
  </view>

  <t-popup
    placement="bottom"
    overlay
    usingCustomNavbar
    visible="{{isPlusMenuVisible}}"
    bind:visible-change="onPlusMenuVisibleChange"
  >
    <view class="lb-chat__plus-menu">
      <view class="lb-chat__plus-menu-handle" />
      <t-grid column="2">
        <t-grid-item text="相册" icon="image" bind:click="onTapSimulateImage" />
        <t-grid-item text="文件" icon="file" bind:click="onTapSimulateFile" />
      </t-grid>
    </view>
  </t-popup>
</view>
