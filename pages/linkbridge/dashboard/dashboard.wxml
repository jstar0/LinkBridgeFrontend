<view class="lb-page">
  <t-navbar title="消息列表">
    <view slot="capsule" class="lb-dashboard__capsule">
      <t-icon
        class="lb-dashboard__capsule-icon"
        name="history"
        size="40rpx"
        bind:tap="onTapArchive"
        aria-role="button"
        aria-label="历史归档"
      />
    </view>
  </t-navbar>

  <view class="lb-page__content">
    <view wx:if="{{activeSessions.length > 0}}" class="lb-dashboard__sessions">
      <t-cell-group bordered="{{false}}">
        <t-cell
          wx:for="{{activeSessions}}"
          wx:key="id"
          title="{{item.peer.displayName}}"
          description="{{item.lastMessagePreview}}"
          hover
          bind:tap="onTapSession"
          data-session-id="{{item.id}}"
          data-peer="{{item.peer}}"
        >
          <view slot="left-icon" class="lb-dashboard__avatar-wrapper">
            <t-avatar icon="user" shape="round" />
          </view>
          <view slot="note" class="lb-dashboard__cell-note">
            <text class="lb-dashboard__time">{{item.timeText}}</text>
          </view>
        </t-cell>
      </t-cell-group>
    </view>

    <t-empty wx:else description="暂无消息" />
  </view>

  <t-fab
    icon="qrcode"
    aria-label="建立会话"
    usingCustomNavbar
    button-props="{{myQrFabButtonProps}}"
    bind:click="onTapMyQr"
  />

  <t-popup
    visible="{{isConnectionModalVisible}}"
    placement="center"
    overlay
    usingCustomNavbar
    bind:visible-change="onConnectionModalVisibleChange"
  >
    <view class="lb-connection-modal">
      <view class="lb-connection-modal__header">
        <text class="lb-connection-modal__title">建立会话</text>
        <t-icon
          class="lb-connection-modal__close"
          name="close"
          size="48rpx"
          bind:tap="onCloseConnectionModal"
          aria-role="button"
          aria-label="关闭"
        />
      </view>

      <view class="lb-connection-modal__qr">
        <image
          wx:if="{{mySessionQrUrl}}"
          class="lb-connection-modal__qr-image"
          mode="aspectFit"
          src="{{mySessionQrUrl}}"
          show-menu-by-longpress
        />
        <view wx:else class="lb-connection-modal__qr-placeholder">
          <text class="lb-connection-modal__placeholder-text">二维码生成中...</text>
        </view>
      </view>

      <t-button theme="primary" variant="outline" bind:tap="onTapScanSession" style="margin-top: 24rpx; width: 100%;">
        扫一扫建立会话
      </t-button>

      <view class="lb-connection-modal__hint">让对方扫描此二维码与你建立会话</view>
    </view>
  </t-popup>

  <linkbridge-tabbar value="dashboard" />
</view>
