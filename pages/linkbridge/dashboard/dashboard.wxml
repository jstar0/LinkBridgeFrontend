<view class="lb-page">
  <t-navbar title="消息列表">
    <view slot="capsule" class="lb-dashboard__capsule">
      <t-icon
        class="lb-dashboard__capsule-icon"
        name="history"
        size="40rpx"
        bind:tap="onTapArchive"
        aria-role="button"
        aria-label="历史归档"
      />
    </view>
  </t-navbar>

  <view class="lb-page__content">
    <view class="lb-dashboard__search">
      <t-search placeholder="搜索用户" value="{{searchValue}}" bind:change="onSearchChange" bind:submit="onSearchSubmit" />
    </view>

    <view wx:if="{{activeSessions.length > 0}}" class="lb-dashboard__sessions">
      <t-cell-group bordered="{{false}}">
        <t-cell
          wx:for="{{activeSessions}}"
          wx:key="id"
          title="{{item.peer.displayName}}"
          description="{{item.lastMessagePreview}}"
          hover
          bind:tap="onTapSession"
          data-session-id="{{item.id}}"
          data-peer="{{item.peer}}"
        >
          <view slot="left-icon" class="lb-dashboard__avatar-wrapper">
            <t-avatar icon="user" shape="round" />
          </view>
          <view slot="note" class="lb-dashboard__cell-note">
            <text class="lb-dashboard__time">{{item.timeText}}</text>
          </view>
        </t-cell>
      </t-cell-group>
    </view>

    <t-empty wx:else description="暂无消息" />
  </view>

  <t-fab
    icon="qrcode"
    aria-label="我的信息"
    usingCustomNavbar
    customStyle="bottom: 220px;"
    button-props="{{myQrFabButtonProps}}"
    bind:click="onTapMyQr"
  />

  <t-fab
    icon="search"
    aria-label="搜索用户"
    usingCustomNavbar
    customStyle="bottom: 140px;"
    bind:click="onTapSearch"
  />

  <t-popup
    visible="{{isConnectionModalVisible}}"
    placement="center"
    overlay
    usingCustomNavbar
    bind:visible-change="onConnectionModalVisibleChange"
  >
    <view class="lb-connection-modal">
      <view class="lb-connection-modal__header">
        <text class="lb-connection-modal__title">我的信息</text>
        <t-icon
          class="lb-connection-modal__close"
          name="close"
          size="48rpx"
          bind:tap="onCloseConnectionModal"
          aria-role="button"
          aria-label="关闭"
        />
      </view>

      <view class="lb-connection-modal__info" wx:if="{{currentUser}}">
        <view class="lb-connection-modal__row">
          <text class="lb-connection-modal__label">用户名</text>
          <text class="lb-connection-modal__value">{{currentUser.username}}</text>
        </view>
        <view class="lb-connection-modal__row">
          <text class="lb-connection-modal__label">显示名称</text>
          <text class="lb-connection-modal__value">{{currentUser.displayName}}</text>
        </view>
        <view class="lb-connection-modal__row">
          <text class="lb-connection-modal__label">用户ID</text>
          <text class="lb-connection-modal__value lb-connection-modal__id" bind:tap="onCopyUserId">{{currentUser.id}}</text>
        </view>
      </view>

      <view class="lb-connection-modal__hint">点击用户ID可复制，分享给好友添加</view>
    </view>
  </t-popup>

  <linkbridge-tabbar value="dashboard" />
</view>
