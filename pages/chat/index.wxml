<wxs src="./index.wxs" module="utils" />

<t-navbar class="nav-bar" title="{{ archived ? name + ' [已归档]' : name }}" left-arrow>
  <view wx:if="{{!archived}}" slot="right" class="chat-nav__right">
    <t-icon name="call" size="48rpx" color="#000000e6" bind:tap="onTapVoiceCall" />
  </view>
</t-navbar>

<view class="chat-container">
  <scroll-view id="chatScroll" class="content" scroll-y scroll-with-animation="{{ false }}" scroll-top="{{ scrollTop }}">
    <view class="messages">
      <block wx:for="{{ messages }}" wx:key="index">
        <!-- Show reactivation divider if this is the first message after reactivation -->
        <view wx:if="{{ reactivatedAt && item.time >= reactivatedAt && (index === 0 || messages[index - 1].time < reactivatedAt) }}" class="reactivation-divider">
          <view class="divider-line"></view>
          <view class="divider-text">会话已重新激活 {{ utils.formatTime(reactivatedAt) }}</view>
          <view class="divider-line"></view>
        </view>

        <view wx:if="{{ index === 0 || item.time - messages[index - 1].time > 120000 }}" class="time" >
          {{ utils.formatTime(item.time) }}
        </view>

        <view wx:if="{{ item.from === 0 }}" class="message-area">
          <view
            class="message self {{ item.burnAfterSec > 0 && !item.burned && !item.burnRead ? 'lb-burn-observe' : '' }}"
            data-mid="{{ item.messageId }}"
          >
          <block wx:if="{{ item.type === 'text' }}">
            <view wx:if="{{ item.burnAfterSec > 0 && !item.burned }}" class="burn-tip">
              <text wx:if="{{ item.burnRead }}">{{ item.burnRemainingSec }}s 后焚毁</text>
              <text wx:else>阅后 {{ item.burnAfterSec }}s 焚毁</text>
            </view>
            <text space="nbsp">{{ item.content }}</text>
          </block>
          <block wx:elif="{{ item.type === 'image' }}">
            <image
              class="msg-image"
              mode="widthFix"
              src="{{ utils.fileUrl(item.meta.url) }}"
              bind:tap="onTapImageMessage"
              data-url="{{ item.meta.url }}"
            />
          </block>
          <block wx:elif="{{ item.type === 'file' }}">
            <view class="msg-file" bind:tap="onTapFileMessage" data-url="{{ item.meta.url }}" data-name="{{ item.meta.name }}">
              <t-icon name="file" size="40rpx" />
              <view class="msg-file__name">{{ item.meta.name }}</view>
            </view>
          </block>
          <t-loading
            wx:if="{{ item.messageId === null }}"
            t-class="loading"
            theme="spinner"
            size="32rpx"
            class="wrapper"
          />
          </view>
          <t-avatar image="{{ myAvatar }}" size="small" />
        </view>

        <view wx:else class="message-area">
          <t-avatar image="{{ avatar }}" size="small" bind:tap="onTapPeerAvatar" />
          <view
            class="message other {{ item.burnAfterSec > 0 && !item.burned && !item.burnRead ? 'lb-burn-observe' : '' }}"
            data-mid="{{ item.messageId }}"
          >
          <block wx:if="{{ item.type === 'text' }}">
            <view wx:if="{{ item.burnAfterSec > 0 && !item.burned }}" class="burn-tip">
              <text wx:if="{{ item.burnRead }}">{{ item.burnRemainingSec }}s 后焚毁</text>
              <text wx:else>阅后 {{ item.burnAfterSec }}s 焚毁</text>
            </view>
            <text space="nbsp">{{ item.content }}</text>
          </block>
          <block wx:elif="{{ item.type === 'image' }}">
            <image
              class="msg-image"
              mode="widthFix"
              src="{{ utils.fileUrl(item.meta.url) }}"
              bind:tap="onTapImageMessage"
              data-url="{{ item.meta.url }}"
            />
          </block>
          <block wx:elif="{{ item.type === 'file' }}">
            <view class="msg-file" bind:tap="onTapFileMessage" data-url="{{ item.meta.url }}" data-name="{{ item.meta.name }}">
              <t-icon name="file" size="40rpx" />
              <view class="msg-file__name">{{ item.meta.name }}</view>
            </view>
          </block>
          </view>
        </view>
      </block>
      <view id="bottom" />
      <view class="lb-bottom-spacer" style="height: {{ bottomSpacer }}px;" />
    </view>
  </scroll-view>
</view>


<view wx:if="{{archived}}" class="archived-notice">
  ⚠️ 此会话已归档，无法发送消息
</view>
<view wx:else class="bottom" style="margin-bottom: {{ keyboardHeight }}px">
  <view class="more" bind:tap="onTapMore">
    <t-icon name="add" size="44rpx" color="#00000099" />
  </view>
  <view class="input">
    <input
      value="{{ input }}"
      type="text"
      confirm-type="send"
      placeholder="请输入"
      placeholder-style="color: #00000066"
      adjust-position="{{ false }}"
      hold-keyboard
      confirm-hold
      bindfocus="handleFocus"
      bindkeyboardheightchange="handleKeyboardHeightChange"
      bindblur="handleBlur"
      bindinput="handleInput"
      bindconfirm="sendMessage"
    />
  </view>
  <t-button class="send" theme="primary" shape="round" disabled="{{ !input }}" bind:tap="sendMessage">发送</t-button>
</view>

<t-popup visible="{{drawerVisible}}" placement="bottom" overlay bind:visible-change="onDrawerVisibleChange">
  <view class="action-drawer">
    <view class="action-drawer__header">
      <view class="action-drawer__title">选择操作</view>
      <t-icon name="close" size="48rpx" bind:tap="onCloseDrawer" />
    </view>

    <view class="action-drawer__row">
      <view class="action-drawer__row-left">
        <view class="action-drawer__row-title">阅后即焚</view>
        <view class="action-drawer__row-sub">{{ burnSeconds }} 秒</view>
      </view>
      <t-switch value="{{ burnEnabled }}" bind:change="onToggleBurn" />
    </view>

    <view class="action-drawer__content">
      <view class="action-item" bind:tap="sendImage">
        <view class="action-item__icon">
          <t-icon name="image" size="56rpx" color="#576b95" />
        </view>
        <view class="action-item__text">图片</view>
      </view>
      <view class="action-item" bind:tap="sendFile">
        <view class="action-item__icon">
          <t-icon name="folder" size="56rpx" color="#576b95" />
        </view>
        <view class="action-item__text">文件</view>
      </view>
      <view class="action-item" bind:tap="onTapVoiceCall">
        <view class="action-item__icon">
          <t-icon name="call" size="56rpx" color="#576b95" />
        </view>
        <view class="action-item__text">语音通话</view>
      </view>
      <view class="action-item" bind:tap="onTapVideoCall">
        <view class="action-item__icon">
          <t-icon name="video" size="56rpx" color="#576b95" />
        </view>
        <view class="action-item__text">视频通话</view>
      </view>
    </view>
  </view>
</t-popup>

<!-- Floating call window -->
<movable-area wx:if="{{activeCall}}" class="floating-area">
  <movable-view class="floating-window" direction="all" inertia>
    <view class="floating-content" catchtap="onRestoreCall">
      <t-icon name="{{activeCall.mediaType === 'video' ? 'video' : 'call'}}" size="56rpx" color="#07c160" />
      <view class="floating-status">{{activeCall.statusText}}</view>
    </view>
  </movable-view>
</movable-area>
