<wxs src="./index.wxs" module="utils" />

<t-navbar class="nav-bar" title="{{ name }}" left-arrow>
  <view slot="right" class="chat-nav__right">
    <t-icon name="call" size="48rpx" color="#000000e6" bind:tap="onTapVoiceCall" />
  </view>
</t-navbar>

<view class="chat-container">
  <scroll-view class="content" scroll-y scroll-into-view="{{ anchor }}">
    <view class="messages">
      <block wx:for="{{ messages }}" wx:key="index">
        <view wx:if="{{ index === 0 || item.time - messages[index - 1].time > 120000 }}" class="time" >
          {{ utils.formatTime(item.time) }}
        </view>

        <view wx:if="{{ item.from === 0 }}" class="message-area">
          <view class="message self">
          <block wx:if="{{ item.type === 'text' }}">
            <text space="nbsp">{{ item.content }}</text>
          </block>
          <block wx:elif="{{ item.type === 'image' }}">
            <image
              class="msg-image"
              mode="widthFix"
              src="{{ utils.fileUrl(item.meta.url) }}"
              bind:tap="onTapImageMessage"
              data-url="{{ item.meta.url }}"
            />
          </block>
          <block wx:elif="{{ item.type === 'file' }}">
            <view class="msg-file" bind:tap="onTapFileMessage" data-url="{{ item.meta.url }}">
              <t-icon name="file" size="40rpx" />
              <view class="msg-file__name">{{ item.meta.name }}</view>
            </view>
          </block>
          <t-loading
            wx:if="{{ item.messageId === null }}"
            t-class="loading"
            theme="spinner"
            size="32rpx"
            class="wrapper"
          />
          </view>
          <t-avatar image="{{ myAvatar }}" size="small" />
        </view>

        <view wx:else class="message-area">
          <t-avatar image="{{ avatar }}" size="small" bind:tap="onTapPeerAvatar" />
          <view class="message other">
          <block wx:if="{{ item.type === 'text' }}">
            <text space="nbsp">{{ item.content }}</text>
          </block>
          <block wx:elif="{{ item.type === 'image' }}">
            <image
              class="msg-image"
              mode="widthFix"
              src="{{ utils.fileUrl(item.meta.url) }}"
              bind:tap="onTapImageMessage"
              data-url="{{ item.meta.url }}"
            />
          </block>
          <block wx:elif="{{ item.type === 'file' }}">
            <view class="msg-file" bind:tap="onTapFileMessage" data-url="{{ item.meta.url }}">
              <t-icon name="file" size="40rpx" />
              <view class="msg-file__name">{{ item.meta.name }}</view>
            </view>
          </block>
          </view>
        </view>
      </block>
      <view id="bottom" />
    </view>
  </scroll-view>
</view>

<view class="block" style="margin-bottom: {{ keyboardHeight }}px" />
<view class="bottom" style="margin-bottom: {{ keyboardHeight }}px">
  <view class="more" bind:tap="onTapMore">
    <t-icon name="add" size="44rpx" color="#00000099" />
  </view>
  <view class="input">
    <input
      value="{{ input }}"
      type="text"
      confirm-type="send"
      placeholder="请输入"
      placeholder-style="color: #00000066"
      adjust-position="{{ false }}"
      hold-keyboard
      confirm-hold
      bindkeyboardheightchange="handleKeyboardHeightChange"
      bindblur="handleBlur"
      bindinput="handleInput"
      bindconfirm="sendMessage"
    />
  </view>
  <t-button class="send" theme="primary" shape="round" disabled="{{ !input }}" bind:tap="sendMessage">发送</t-button>
</view>

<t-popup visible="{{peerProfileVisible}}" placement="bottom" overlay bind:visible-change="onPeerProfileVisibleChange">
  <view class="peer-profile">
    <view class="peer-profile__header">
      <t-avatar image="{{peerProfile.avatarUrl}}" size="large" />
      <view class="peer-profile__meta">
        <view class="peer-profile__name">{{peerProfile.displayName}}</view>
        <view class="peer-profile__sub">{{peerProfile.username}}</view>
      </view>
    </view>

    <view class="peer-profile__actions">
      <t-button theme="primary" size="large" block bind:tap="onTapVoiceCall">语音通话</t-button>
      <t-button
        theme="default"
        variant="outline"
        size="large"
        block
        style="margin-top: 16rpx;"
        bind:tap="onClosePeerProfile"
      >
        关闭
      </t-button>
    </view>
  </view>
</t-popup>
