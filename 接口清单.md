# 接口清单（与后端 main 对齐）

本文件用于汇总“前端依赖的接口契约”，并保证与后端 `main` 分支实现保持一致。  
后续每次前端新增一个需要后端支持的能力：**必须同时**更新两处：

1) `LinkBridgeFrontend/utils/linkbridge/api.js`：新增函数 + 顶部注释契约（Method/Path/Schema/Error codes）  
2) `LinkBridgeFrontend/接口清单.md`：追加该接口说明（便于后端统一查看）

> 术语：全程使用“微信码/小程序码（WeChat Code/WxaCode）”“社交关系/会话（Relationship/Session）”，不使用“二维码/好友”。

---

## 通用约定

- **鉴权**：需要登录的接口使用 `Authorization: Bearer <token>`  
- **成功响应**：HTTP `2xx`，JSON body  
- **错误响应**：非 `2xx` 时返回 JSON：
  - `{"error": {"code": "SOME_CODE", "message": "human readable message"}}`
- **WebSocket 事件命名**：沿用已存在事件名；新增按 `domain.action`（例如 `localfeed.post.created`）

---

## A：本地信息流（Local Feed）

### A1 Home Base Address（个人唯一地址）

#### 1) 获取 Home Base
- Method/Path：`GET /v1/home-base`
- Auth：需要
- Response：
  - `homeBase: { lat: number, lng: number, radiusM: number, lastUpdatedYmd: number, updatedAtMs: number } | null`
- Errors：
  - `TOKEN_INVALID` / `TOKEN_EXPIRED`

#### 2) 设置/更新 Home Base（每日最多修改位置 3 次，0 点重置）
- Method/Path：`PUT /v1/home-base`
- Auth：需要
- Request body：
  - `lat: number`（required）
  - `lng: number`（required）
  - `radiusM?: number`（optional；账号级可见范围，单位：米）
- Response：
  - `homeBase: { lat: number, lng: number, radiusM: number, lastUpdatedYmd: number, updatedAtMs: number }`
- Errors（至少需要）：
  - `TOKEN_INVALID` / `TOKEN_EXPIRED`
  - `VALIDATION_ERROR`
  - `HOME_BASE_UPDATE_LIMITED`（自然日 0 点重置，1 天最多修改 3 次位置）

---

### A2 发布（Post）

#### 3) 创建发布
- Method/Path：`POST /v1/local-feed/posts`
- Auth：需要
- Request body（后端 main 实现口径）：
  - `text?: string`
  - `imageUrls?: string[]`（先走 `POST /v1/upload` 上传，再把返回的 `url` 传入这里）
  - `expiresAtMs?: number`（过期时间戳；默认 now + 30d）
  - `isPinned?: boolean`（默认 false）
- Response：
  - `post: localFeedPostItem`
- localFeedPostItem schema（后端 main 实现）：
  - `id: string`
  - `userId: string`
  - `text?: string`
  - `radiusM: number`
  - `expiresAtMs: number`
  - `isPinned: boolean`
  - `createdAtMs: number`
  - `updatedAtMs: number`
  - `images: { url: string, sortOrder: number }[]`
- Errors：
  - `TOKEN_INVALID` / `TOKEN_EXPIRED`
  - `VALIDATION_ERROR`

#### 4) 获取我的发布
- Method/Path：`GET /v1/local-feed/posts`
- Auth：需要
- Response：
  - `posts: localFeedPostItem[]`

#### 5) 删除我的发布
- Method/Path：`POST /v1/local-feed/posts/:id/delete`
- Auth：需要
- Response：
  - `{ deleted: true }`
- Errors：
  - `TOKEN_INVALID` / `TOKEN_EXPIRED`
  - `VALIDATION_ERROR`
  - `LOCAL_FEED_POST_NOT_FOUND`

---

### A3 地图 Pins（地图点位）

#### 6) 获取地图 pins（按视野范围 + center + limit）
- Method/Path：`GET /v1/local-feed/pins`
- Auth：建议需要（至少要能按用户可见规则做裁剪）
- Query：
  - `minLat=<number>`（required）
  - `maxLat=<number>`（required）
  - `minLng=<number>`（required）
  - `maxLng=<number>`（required）
  - `centerLat=<number>`（required，用于按距离排序）
  - `centerLng=<number>`（required）
  - `limit=<number>`（optional；默认 200）
- Response：
  - `pins: Pin[]`
- Pin schema（后端 main 实现）：
  - `userId: string`
  - `displayName: string`
  - `avatarUrl?: string`
  - `lat: number`（Home Base Address）
  - `lng: number`
  - `updatedAtMs: number`

---

### A4 信息源（Profile/Feed）

#### 7) 获取某用户对“当前查看者”可见的发布列表
- Method/Path：`GET /v1/local-feed/users/:userId/posts`
- Auth：建议需要（至少要知道 viewer 身份；也便于反滥用/灰度）
- Query：
  - `atLat=<number>`（optional；用于按发布者账号可见范围（Home Base radiusM）判断可见，建议尽量传）
  - `atLng=<number>`（optional）
- Response：
  - `posts: localFeedPostItem[]`（后端会做有效期 + 可见范围 + 置顶排序等裁剪）

---

## B：地图关系请求（Map Relationship Request，复用 session request 模型）

> 需求硬规则：地图发起聊天/建立关系必须“对方同意后才显示在会话列表中”；按钮态要体现等待/冷却/上限；支持验证消息。

### 1) 创建会话请求接口：支持 `verificationMessage`
- Method/Path：`POST /v1/session-requests`
- Auth：需要
- Request body（后端 main 实现口径）：
  - `addresseeId: string`（required）
  - `verificationMessage?: string`（optional；建议最大 120）
- Response：
  - `request: { id, requesterId, addresseeId, status, source, createdAtMs, updatedAtMs, verificationMessage? }`
  - `created: boolean`
  - `hint?: string`

### 2) 反滥用（必须由后端保证）
- Rate limit：每用户每日最多发起 10 个新的地图关系请求（自然日 0 点重置）
  - 错误码：`RATE_LIMITED`
- Cooldown：若对方拒绝，则 3 天内不能向同一人重复发送请求
  - 错误码：`COOLDOWN_ACTIVE`

### 3) WS 事件字段补齐（建议）
- 事件：`session.requested` / `session.request.accepted` / `session.request.rejected`
- Payload 中的 `request` 建议包含 `verificationMessage`（用于前端在“请求列表”展示）

---

## C：会话分组（Relationship Groups）

> 用于“会话列表分组/管理社交关系”。前端默认按来源自动分组（微信码/地图/活动/其他），用户也可以把某个会话移动到自定义分组。

### C1 分组管理

#### 1) 列出分组
- Method/Path：`GET /v1/relationship-groups`
- Auth：需要
- Response：
  - `groups: { id: string, name: string, createdAtMs: number, updatedAtMs: number }[]`

#### 2) 创建分组
- Method/Path：`POST /v1/relationship-groups`
- Auth：需要
- Request body：
  - `name: string`（required；建议 <= 24）
- Response：
  - `group: { id: string, name: string, createdAtMs: number, updatedAtMs: number }`
- Errors：
  - `TOKEN_INVALID` / `TOKEN_EXPIRED`
  - `VALIDATION_ERROR`

#### 3) 重命名分组（可选）
- Method/Path：`POST /v1/relationship-groups/:id/rename`
- Auth：需要
- Request body：
  - `name: string`（required）
- Response：
  - `group: { id: string, name: string, createdAtMs: number, updatedAtMs: number }`

#### 4) 删除分组（可选）
- Method/Path：`POST /v1/relationship-groups/:id/delete`
- Auth：需要
- Response：
  - `{ deleted: true }`

### C2 会话与分组绑定

#### 5) 更新会话的社交关系信息（分组/备注/标签）
- Method/Path：`PUT /v1/sessions/:id/relationship`
- Auth：需要
- Request body（按需传，支持 partial patch）：
  - `groupId?: string | null`（把会话放入某分组；null 表示移出分组）
  - `note?: string`（可选，<= 120）
  - `tags?: string[]`（可选）
- Response：
  - `relationship: { groupId?, groupName?, note?, tags?, updatedAtMs }`
- Errors：
  - `TOKEN_INVALID` / `TOKEN_EXPIRED`
  - `VALIDATION_ERROR`
