# 接口清单（后端待实现/待对齐）

本文件用于汇总“前端已经开始依赖、但后端尚未实现或需要扩展字段/错误码”的接口清单。  
后续每次前端新增一个需要后端支持的能力：**必须同时**更新两处：

1) `LinkBridgeFrontend/utils/linkbridge/api.js`：新增函数 + 顶部注释契约（Method/Path/Schema/Error codes）  
2) `LinkBridgeFrontend/接口清单.md`：追加该接口说明（便于后端统一查看）

> 术语：全程使用“微信码/小程序码（WeChat Code/WxaCode）”“社交关系/会话（Relationship/Session）”，不使用“二维码/好友”。

---

## 通用约定

- **鉴权**：需要登录的接口使用 `Authorization: Bearer <token>`  
- **成功响应**：HTTP `2xx`，JSON body  
- **错误响应**：非 `2xx` 时返回 JSON：
  - `{"error": {"code": "SOME_CODE", "message": "human readable message"}}`
- **WebSocket 事件命名**：沿用已存在事件名；新增按 `domain.action`（例如 `localfeed.post.created`）

---

## A：本地信息流（Local Feed）

### A1 Home Base Address（个人唯一地址）

#### 1) 获取 Home Base
- Method/Path：`GET /v1/localfeed/home-base`
- Auth：需要
- Response：
  - `homeBase: { name?: string, lat: number, lng: number, updatedAtMs: number } | null`
- Errors：
  - `TOKEN_INVALID` / `TOKEN_EXPIRED`

#### 2) 设置/更新 Home Base（每日最多 1 次，0 点重置）
- Method/Path：`PUT /v1/localfeed/home-base`
- Auth：需要
- Request body：
  - `name?: string`
  - `lat: number`（required）
  - `lng: number`（required）
- Response：
  - `homeBase: { name?: string, lat: number, lng: number, updatedAtMs: number }`
- Errors（至少需要）：
  - `TOKEN_INVALID` / `TOKEN_EXPIRED`
  - `VALIDATION`
  - `HOME_BASE_DAILY_LIMIT`（自然日 0 点重置，1 天最多修改 1 次）

---

### A2 发布（Post）

#### 3) 创建发布
- Method/Path：`POST /v1/localfeed/posts`
- Auth：需要
- Request body（建议）：
  - `text?: string`
  - `images?: string[]`（前端可上传后填 URL/ID；具体格式以你们最终上传方案为准）
  - `pinned?: boolean`
  - `radiusKm: number`（required，默认 1）
  - `expiresAtMs: number`（required，默认 now + 30d）
- Response：
  - `post: Post`
- Post schema（建议字段，后端可扩展）：
  - `id: string`
  - `author: { userId: string, displayName: string, avatarUrl: string }`
  - `text: string`
  - `images: string[]`
  - `lat: number`（来自 Home Base Address）
  - `lng: number`
  - `pinned: boolean`
  - `radiusKm: number`
  - `createdAtMs: number`
  - `expiresAtMs: number`
- Errors：
  - `TOKEN_INVALID` / `TOKEN_EXPIRED`
  - `VALIDATION`

#### 4) 获取我的发布
- Method/Path：`GET /v1/localfeed/posts/mine`
- Auth：需要
- Response：
  - `posts: Post[]`

#### 5) 删除我的发布
- Method/Path：`DELETE /v1/localfeed/posts/:id`
- Auth：需要
- Response：
  - `{ ok: true }`
- Errors：
  - `TOKEN_INVALID` / `TOKEN_EXPIRED`
  - `VALIDATION`
  - `NOT_FOUND` / `ACCESS_DENIED`（按你们现有风格命名即可，但需稳定）

---

### A3 地图 Pins（地图点位）

#### 6) 获取地图 pins（按视野/bbox/zoom/limit）
- Method/Path：`GET /v1/localfeed/map/pins`
- Auth：建议需要（至少要能按用户可见规则做裁剪）
- Query：
  - `bbox=swLat,swLng,neLat,neLng`（required）
  - `zoom=<number>`（optional，但建议给，用于聚合/分层策略）
  - `limit=<number>`（optional；后端可强制上限）
- Response：
  - `pins: Pin[]`
- Pin schema（建议）：
  - `userId: string`
  - `displayName: string`
  - `avatarUrl: string`
  - `lat: number`（Home Base Address）
  - `lng: number`
  - `hasPosts: boolean`
  - `topPostPreview?: string`（可选：用于点位气泡预览）

---

### A4 信息源（Profile/Feed）

#### 7) 获取某用户对“当前查看者”可见的发布列表
- Method/Path：`GET /v1/localfeed/users/:userId/posts`
- Auth：建议需要（至少要知道 viewer 身份；也便于反滥用/灰度）
- Query：
  - `viewerLat=<number>`（required；用于按发布者 radiusKm 判断可见）
  - `viewerLng=<number>`（required）
- Response：
  - `posts: Post[]`（必须在后端做可见性裁剪：有效期 + 半径 + 置顶排序等）

---

## B：地图关系请求（Map Relationship Request，复用 session request 模型）

> 需求硬规则：地图发起聊天/建立关系必须“对方同意后才显示在会话列表中”；按钮态要体现等待/冷却/上限；支持验证消息。

### 1) 扩展创建会话请求接口：支持 `source=localfeed` + `verificationMessage`
- Method/Path：`POST /v1/session-requests`
- Auth：需要
- Request body（新增/扩展字段）：
  - `addresseeId: string`（required）
  - `source: 'localfeed'`（required）
  - `verificationMessage?: string`（optional；建议最大 120）
- Response：
  - `request: { id, requesterId, addresseeId, status, createdAtMs, updatedAtMs, verificationMessage? }`
  - `created: boolean`
  - `hint?: string`

### 2) 反滥用（必须由后端保证）
- Rate limit：每用户每日最多发起 10 个新的地图关系请求（自然日 0 点重置）
  - 错误码建议：`LOCALFEED_REQUEST_DAILY_LIMIT`
- Cooldown：若对方拒绝，则 3 天内不能向同一人重复发送请求
  - 错误码建议：`LOCALFEED_REQUEST_COOLDOWN`

### 3) WS 事件字段补齐（建议）
- 事件：`session.requested` / `session.request.accepted` / `session.request.rejected`
- Payload 中的 `request` 建议包含 `verificationMessage`（用于前端在“请求列表”展示）

